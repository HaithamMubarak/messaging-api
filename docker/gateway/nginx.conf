user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    client_max_body_size 20M;

    # --- Upstream containers ---
    upstream messaging_service {
        server messaging-service:8082;
    }

    upstream adminer {
        server adminer:80;
    }

    # --- Main Gateway Server ---
    server {
        listen 80 default_server;
        server_name _;

        # Forward basic proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # -------------------------------
        # Adminer section
        # -------------------------------

        # Redirect /messaging-platform/adminer â†’ /messaging-platform/adminer/
        location = /messaging-platform/adminer {
            # Return an absolute redirect so clients preserve host/scheme
            return 301 $scheme://$host/messaging-platform/adminer/;
        }

        # Proxy everything under /messaging-platform/adminer/ to adminer container
        location /messaging-platform/adminer/ {
            # Proxy to the adminer upstream; preserve request path by using the trailing slash
            proxy_pass http://adminer/;
            # Let nginx rewrite redirects from the upstream to the client properly
            proxy_redirect default;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # -------------------------------
        # Messaging Platform API
        # -------------------------------
        location ^~ /messaging-platform/api/ {
            proxy_pass http://messaging_service$request_uri;
            proxy_redirect off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }

        # -------------------------------
        # Web agent and static files
        # -------------------------------
        location /messaging-platform/ {
            proxy_pass http://messaging_service$request_uri;
            proxy_redirect off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }

        # -------------------------------
        # Catch-all (safety)
        # -------------------------------
        location / {
            return 404;
        }
    }
}
