<VirtualHost *:80>
    ServerName gateway.local

    ProxyPreserveHost On
    RewriteEngine On

    # --- Internally handle requests to /messaging-platform/adminer (no trailing slash) without issuing an external 301 ---
    RewriteCond %{REQUEST_URI} ^/messaging-platform/adminer$
    RewriteRule ^ /messaging-platform/adminer/ [L,PT]

    # --- Trailing slash only for "directory-like" URLs (no dot in last path segment)
    # Skip real files (.html, .jpg, .js, etc.) and skip API endpoints under /messaging-platform/api/
    RewriteCond %{REQUEST_URI} ^/messaging-platform/[^?#]+[^/]$
    RewriteCond %{REQUEST_URI} !\.[^/]+$
    RewriteCond %{REQUEST_URI} !^/messaging-platform/api/
    RewriteRule ^ %{REQUEST_URI}/ [R=301,L]

    # --- Adminer (DB management) ---
    ProxyPass        "/messaging-platform/adminer/"  "http://adminer:80/" nocanon
    ProxyPassReverse "/messaging-platform/adminer/"  "http://adminer:80/"

    # --- Messaging Platform (Spring Boot app) ---
    ProxyPass        "/messaging-platform/" "http://messaging-service:8082/messaging-platform/" nocanon
    ProxyPassReverse "/messaging-platform/" "http://messaging-service:8082/messaging-platform/"

    # --- Prevent backend or Apache from appending / to .html URLs ---
    <Location /messaging-platform/>
        Header edit Location "(.*?/messaging-platform/[^?#]*\.[a-zA-Z0-9]+?)/$" "$1"
    </Location>

    ErrorLog /var/log/apache2/gateway-error.log
    CustomLog /var/log/apache2/gateway-access.log combined
</VirtualHost>
